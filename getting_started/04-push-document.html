
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Push a document · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="05-consume-queue.md" />
    
    
    <link rel="prev" href="03-create-queue.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Welcome to Fetchq
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../why.html">
            
                <a href="../why.html">
            
                    
                    Yet another queue system?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="../features.html">
            
                <a href="../features.html">
            
                    
                    Features you will enjoy »
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="./">
            
                <a href="./">
            
                    
                    Getting Started
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="01-setup-postgres.html">
            
                <a href="01-setup-postgres.html">
            
                    
                    Setup Postgres
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="02-initialize-fetchq.html">
            
                <a href="02-initialize-fetchq.html">
            
                    
                    Initialize Fetchq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="03-create-queue.html">
            
                <a href="03-create-queue.html">
            
                    
                    Create a new queue
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.4" data-path="04-push-document.html">
            
                <a href="04-push-document.html">
            
                    
                    Push a document
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="05-consume-queue.md">
            
                <span>
            
                    
                    Consume a queue
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../GLOSSARY.html">
            
                <a href="../GLOSSARY.html">
            
                    
                    Glossary
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Push a document</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="push-a-document">Push a Document</h2>
<p>Now that you have a queue ready, the first action you want to look into is how to push data into it.</p>
<p>There are 3 possible ways to add a document into a queue:</p>
<ul>
<li><code>fetchq_doc_push()</code> - add a unique document by subject</li>
<li><code>fetchq_doc_upsert()</code> - add a unique document by subject, or update an existing document</li>
<li><code>fetchq_doc_append()</code> - add a new document with an auto-generated unique subject</li>
</ul>
<p>In this document I&apos;m going to briefly describe how and in which conditions you may want to use those methods.</p>
<h2 id="fetchqdocpush">fetchq_doc_push</h2>
<pre><code># Function signature
fetchq_doc_push(
  queue::string          // queue name, es: &quot;foo&quot;
  subject::string        // your unique id, es: &quot;john&quot;
  version::int           // the version of the document, es: 0
  priority::int          // an arbitrary priority, es: 0
  nextIteration::date    // when to execute the document, es: &quot;2081-06-30 15:05&quot;
  payload::jsonb         // a json payload, consider it a cookie. es: &apos;{&quot;age&quot;:22}&apos;
)

# SQL Example
SELECT * FROM fetchq_doc_push(&apos;foo&apos;, &apos;john&apos;, 0, 0, NOW() + INTERVAL &apos;20s&apos;, &apos;{}&apos;);
</code></pre><p>If you own the subject of your document you are going to use <code>fetchq_doc_push()</code>. The classic
example is that you have a list of superheroes that you want to monitor by scraping the
website <code>http://avengers.com/{superuser}</code>.</p>
<p>This project requires you to periodically scrape <code>avengers.com</code> on a specific page, which
url can be generated automatically by knowing the name of the superuser. At this point the most
important thing is to do not insert the same superhero twice or we are going to waste time!</p>
<p>In this context the <code>payload</code> does not have much of an importance, but can be used as
storage for informations that need to be carried out between different iterations:</p>
<pre><code># those documents are good because the subject is unique
SELECT * FROM fetchq_doc_push(&apos;avengers&apos;, &apos;ironman&apos;, 0, 0, NOW(), &apos;{ &quot;lastScore&quot;: 20 }&apos;);
SELECT * FROM fetchq_doc_push(&apos;avengers&apos;, &apos;hulk&apos;, 0, 0, NOW(), &apos;{ &quot;lastScore&quot;: 18 }&apos;);
...
# this should be an error because &quot;ironman&quot; was already there!
SELECT * FROM fetchq_doc_push(&apos;avengers&apos;, &apos;ironman&apos;, 0, 0, NOW(), &apos;{ &quot;lastScore&quot;: 20 }&apos;);
</code></pre><p><strong>If you attempt to push duplicates they will simply be ignored</strong>. The function returns the
number of documents that got inserted without causing subject duplication. </p>
<p><strong>NOTE:</strong> this behaviour allow for the fastest possible <code>INSERT</code> performance, expecially when
using the <code>bulk insert</code> signature.</p>
<blockquote>
<p>On an average mac I could measure insert speed of <strong>18K documents per second</strong>
when pushing <strong>5M documents!</strong></p>
</blockquote>
<h2 id="fetchqdocupsert">fetchq_doc_upsert</h2>
<pre><code># Function signature
fetchq_doc_upsert(
  queue::string          // queue name, es: &quot;foo&quot;
  subject::string        // your unique id, es: &quot;john&quot;
  version::int           // the version of the document, es: 0
  priority::int          // an arbitrary priority, es: 0
  nextIteration::date    // when to execute the document, es: &quot;2081-06-30 15:05&quot;
  payload::jsonb         // a json payload, consider it a cookie. es: &apos;{&quot;age&quot;:22}&apos;
)

# SQL Example
SELECT * FROM fetchq_doc_upsert(&apos;foo&apos;, &apos;john&apos;, 0, 1, NOW() + INTERVAL &apos;1m&apos;, &apos;{&quot;age&quot;:22}&apos;);
</code></pre><p><code>upsert</code> shares the same signature as <code>push</code> but it has update capabilities in case the document
already exists in the queue. The following properties will be updated:</p>
<ul>
<li>priority</li>
<li>nextIteration</li>
<li>payload</li>
</ul>
<p><strong>NOTE:</strong> the update will be applied to <a href="../GLOSSARY.html#active-documents" class="glossary-term" title="see: active document">active documents</a> only.</p>
<h2 id="fetchqdocappend">fetchq_doc_append</h2>
<pre><code># Function signature
fetchq_doc_append(
  queue::string          // queue name, es: &quot;foo&quot;
  payload::jsonb         // a json payload, consider it a cookie. es: &apos;{&quot;age&quot;:22}&apos;
  version::int           // the version of the document, es: 0
  priority::int          // an arbitrary priority, es: 0
)

# SQL Example
SELECT * FROM fetchq_doc_append(&apos;foo&apos;, &apos;{&quot;age&quot;:22}&apos;, 0, 1);
</code></pre><p>If you need to queue a document regardless of the subject univocity you append.</p>
<p>In this circumstance the <code>payload</code> becomes the most important piece of information as it is
the only discriminant between documents. Document version and priority work as usual.</p>
<p>A classic example might be a <code>sendmail</code> queue to which we want to append documents that describe
emails that need to be send. The <a href="../GLOSSARY.html#worker" class="glossary-term" title="A worker is an app written in any language you may know (our examples are written in NodeJS)
that pick a document from a queue and process it.">worker</a> will then process the queue, using the payload as source
of the email informations:</p>
<pre><code>SELECT * FROM fetchq_doc_append(&apos;sendmail&apos;, &apos;{&quot;to&quot;:&quot;foo@foo.it&quot;, &quot;template&quot;:&quot;signup&quot;, &quot;subject&quot;:&quot;welcome!&quot;}&apos;, 0, 0);
</code></pre><p>This document will be appended with the current dateTime and will be processed as soon as possible.
Classic implementation of a FIFO queue. In this type of queue the document is likely to be deleted
after a successful iteration, but you may have different needs!</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="03-create-queue.html" class="navigation navigation-prev " aria-label="Previous page: Create a new queue">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="05-consume-queue.md" class="navigation navigation-next " aria-label="Next page: Consume a queue">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Push a document","level":"1.2.4","depth":2,"next":{"title":"Consume a queue","level":"1.2.5","depth":2,"path":"getting_started/05-consume-queue.md","ref":"getting_started/05-consume-queue.md","articles":[]},"previous":{"title":"Create a new queue","level":"1.2.3","depth":2,"path":"getting_started/03-create-queue.md","ref":"getting_started/03-create-queue.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"getting_started/04-push-document.md","mtime":"2018-07-08T11:41:10.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-07-09T06:38:45.986Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

